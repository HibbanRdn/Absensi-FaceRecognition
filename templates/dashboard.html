<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Absensi</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
    body { min-height:100vh; background: linear-gradient(135deg,#0f2027,#203a43,#2c5364); position: relative; overflow-x:hidden; padding:30px; }

    /* Background animasi */
    .gradient-bg { position: fixed; inset:0; z-index:-2; background: linear-gradient(-45deg,#0f172a,#1e293b,#2e1065,#312e81); background-size:400% 400%; animation: gradientMove 20s ease infinite; }
    .blob { position:absolute; border-radius:50%; filter:blur(60px); opacity:0.3; animation: blobMove 30s infinite alternate ease-in-out; z-index:-1; }
    .blob1 { width:600px; height:600px; background:radial-gradient(circle, rgba(88,180,255,0.8) 0%, rgba(88,180,255,0) 60%); top:-150px; left:-150px; }
    .blob2 { width:500px; height:500px; background:radial-gradient(circle, rgba(118,75,162,0.8) 0%, rgba(118,75,162,0) 60%); bottom:-120px; right:-100px; animation-delay:5s; }
    @keyframes gradientMove{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
    @keyframes blobMove{0%{transform:translate(0,0) scale(1);}100%{transform:translate(100px,-80px) scale(1.2);}}

    .dashboard { max-width:1200px; margin:0 auto; background:rgba(255,255,255,0.95); border-radius:14px; padding:30px 40px; box-shadow:0 10px 30px rgba(0,0,0,0.3); backdrop-filter:blur(8px); animation: fadeIn 0.8s ease; position:relative; }

    .dashboard h2 { font-weight:600; color:#111; margin-bottom:6px; }
    .dashboard p { color:#333; margin-bottom:20px; }

    /* Logout button */
    .logout-btn { position:absolute; top:25px; right:30px; background:linear-gradient(135deg,#ff6a6a,#ff3d3d); border:none; color:#fff; font-weight:600; padding:8px 16px; border-radius:8px; cursor:pointer; transition:all 0.3s ease; }
    .logout-btn:hover { transform:translateY(-2px); box-shadow:0 4px 10px rgba(255,61,61,0.4); }

    /* Filters */
    .filters input, .filters select, .filters button { border-radius:8px; transition:0.3s; }
    .filters input:focus, .filters select:focus { outline:none; box-shadow:0 0 6px rgba(127,86,217,0.3); border-color:#7f56d9; }

    table { border-radius:10px; overflow:hidden; }
    table th, table td { vertical-align:middle; }

    /* Highlight row terbaru */
    .latest-row { background: rgba(102,126,234,0.2) !important; }

    /* Statistik cards */
    .stats { display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
    .stat-card { flex:1; min-width:150px; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; border-radius:12px; padding:15px 20px; box-shadow:0 8px 20px rgba(0,0,0,0.2); transition:all 0.3s; }
    .stat-card:hover { transform:translateY(-3px); box-shadow:0 12px 25px rgba(0,0,0,0.3); }

    /* Modal logout */
    #modalLogout { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:10; }
    #modalLogout .modal-content { background:#fff; padding:30px 20px; border-radius:12px; text-align:center; max-width:360px; width:90%; }
    #modalLogout button { margin:5px; }

    @keyframes fadeIn { from{opacity:0;transform:scale(0.98);} to{opacity:1;transform:scale(1);} }
    @media(max-width:768px){ .dashboard{padding:20px;} .logout-btn{top:15px;right:15px;padding:6px 12px;} }
  </style>
</head>
<body>
  <div class="gradient-bg"></div>
  <div class="blob blob1"></div>
  <div class="blob blob2"></div>

  <div class="dashboard">
    <button class="logout-btn" id="btnLogout">üö™ Logout</button>
    <h2>üìä Dashboard Absensi</h2>
    <p>Laporan kehadiran mahasiswa di laboratorium</p>

    <!-- Statistik ringkas -->
    <div class="stats">
      <div class="stat-card">
        <h5>Total Mahasiswa</h5>
        <p id="totalStudents">0</p>
      </div>
      <div class="stat-card">
        <h5>Hadir Hari Ini</h5>
        <p id="presentToday">0</p>
      </div>
      <div class="stat-card">
        <h5>Persentase Kehadiran</h5>
        <p id="attendancePercent">0%</p>
      </div>
    </div>

    <!-- Search & Filter -->
    <div class="d-flex flex-wrap gap-2 mb-3 filters">
      <input type="text" id="searchBox" class="form-control" placeholder="üîç Cari nama atau NPM">
      <input type="date" id="filterDate" class="form-control">
      <select id="rowsPerPage" class="form-select" style="max-width:120px;">
        <option value="10">10 / halaman</option>
        <option value="25">25 / halaman</option>
        <option value="50">50 / halaman</option>
      </select>
      <a href="{{ url_for('export_absensi') }}" class="btn btn-success">‚¨áÔ∏è Export CSV</a>
    </div>

    <!-- Tabel Absensi -->
    <table class="table table-dark table-hover rounded">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nama</th>
          <th>NPM</th>
          <th>Waktu</th>
        </tr>
      </thead>
      <tbody id="absensi-body"></tbody>
    </table>

    <!-- Pagination -->
    <nav>
      <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
  </div>

  <!-- Modal Logout -->
  <div id="modalLogout">
    <div class="modal-content">
      <h5>Konfirmasi Logout</h5>
      <p>Apakah Anda yakin ingin keluar?</p>
      <div>
        <form method="get" action="{{ url_for('logout') }}" style="display:inline">
          <button type="submit" class="btn btn-danger">Ya, Logout</button>
        </form>
        <button type="button" class="btn btn-secondary" id="cancelLogout">Batal</button>
      </div>
    </div>
  </div>

  <script>
    let absensiData = [];
    let filteredData = [];
    let currentPage = 1;
    let rowsPerPage = 10;

    async function loadAbsensi() {
      try {
        const res = await fetch("/absensi");
        absensiData = await res.json();
        updateStats();
        applyFilters();
      } catch (err) {
        console.error("Gagal memuat data absensi:", err);
      }
    }

    function updateStats() {
      const total = absensiData.length;
      const today = new Date().toISOString().split('T')[0];
      const presentToday = absensiData.filter(d => d.waktu.startsWith(today)).length;
      const percent = total ? Math.round((presentToday / total) * 100) : 0;
      document.getElementById("totalStudents").innerText = total;
      document.getElementById("presentToday").innerText = presentToday;
      document.getElementById("attendancePercent").innerText = percent + "%";
    }

    function renderTable(data) {
      const tbody = document.getElementById("absensi-body");
      tbody.innerHTML = "";

      if(data.length === 0){
        tbody.innerHTML = `<tr><td colspan="4">Belum ada data absensi</td></tr>`;
        document.getElementById("pagination").innerHTML = "";
        return;
      }

      const start = (currentPage-1)*rowsPerPage;
      const end = start+rowsPerPage;
      const pageData = data.slice(start,end);

      pageData.forEach((item, idx) => {
        const latestClass = (idx === 0 && currentPage===1) ? 'latest-row' : '';
        tbody.innerHTML += `
          <tr class="${latestClass}">
            <td>${item.id}</td>
            <td title="Klik untuk detail">${item.name}</td>
            <td>${item.npm || "-"}</td>
            <td>${item.waktu}</td>
          </tr>`;
      });

      renderPagination(data.length);
    }

    function renderPagination(totalRows){
      const totalPages = Math.ceil(totalRows / rowsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      if(totalPages<=1) return;

      pagination.innerHTML += `<li class="page-item ${currentPage===1?'disabled':''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage-1})">Previous</a></li>`;

      for(let i=1;i<=totalPages;i++){
        pagination.innerHTML += `<li class="page-item ${i===currentPage?'active':''}">
          <a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
      }

      pagination.innerHTML += `<li class="page-item ${currentPage===totalPages?'disabled':''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage+1})">Next</a></li>`;
    }

    function changePage(page){
      currentPage = page;
      renderTable(filteredData);
    }

    document.getElementById("searchBox").addEventListener("input", applyFilters);
    document.getElementById("filterDate").addEventListener("change", applyFilters);
    document.getElementById("rowsPerPage").addEventListener("change", e=>{
      rowsPerPage = parseInt(e.target.value);
      currentPage =1;
      renderTable(filteredData);
    });

    function applyFilters(){
      const keyword = document.getElementById("searchBox").value.toLowerCase();
      const selectedDate = document.getElementById("filterDate").value;
      filteredData = absensiData.filter(item=>{
        const matchKeyword = item.name.toLowerCase().includes(keyword) || (item.npm && item.npm.toLowerCase().includes(keyword));
        const matchDate = selectedDate ? item.waktu.startsWith(selectedDate) : true;
        return matchKeyword && matchDate;
      });
      currentPage=1;
      renderTable(filteredData);
    }

   const modal=document.getElementById('modalLogout');
    document.getElementById('btnLogout').onclick=()=>modal.style.display='flex';
    document.getElementById('cancelLogout').onclick=()=>modal.style.display='none';

    loadAbsensi();
  </script>
</body>
</html>
